<?php

use App\Models\Factor;
use App\Models\User;
use App\Models\Vulnerability;
use Illuminate\Testing\TestResponse;
use Laravel\Sanctum\Sanctum;

beforeEach(function () {
    $this->routeName = 'vulnerabilities.factors.delete';

    $this->user = User::factory()->create();
    Sanctum::actingAs($this->user);

    $this->vulnerability = Vulnerability::factory()->create([
        'user_id' => $this->user->id,
    ]);

    $this->factor = Factor::factory()->create([
        'vulnerability_id' => $this->vulnerability->id,
    ]);
});

it('responds with status 404 if vulnerability not found', function () {
    $route = route($this->routeName, ['vulnerability' => 123456, 'factor' => $this->factor->id]);

    /** @var TestResponse $response */
    $response = $this->delete($route);

    $response->assertNotFound();
});

it('responds with status 404 if factor not found', function () {
    $route = route($this->routeName, ['vulnerability' => $this->vulnerability->id, 'factor' => 123456]);

    /** @var TestResponse $response */
    $response = $this->delete($route);

    $response->assertNotFound();
});

it('responds with status 403 if user not authorized to delete factor', function () {
    $route = route($this->routeName, ['vulnerability' => $this->vulnerability->id, 'factor' => $this->factor->id]);

    $user = User::factory()->create([
        'is_admin' => false,
    ]);

    Sanctum::actingAs($user);

    /** @var TestResponse $response */
    $response = $this->delete($route);

    $response->assertForbidden();
});

it('deletes factor', function () {
    $route = route($this->routeName, ['vulnerability' => $this->vulnerability->id, 'factor' => $this->factor->id]);

    /** @var TestResponse $response */
    $response = $this->deleteJson($route);

    $response->assertOk()->assertJsonStructure(['message']);
});
