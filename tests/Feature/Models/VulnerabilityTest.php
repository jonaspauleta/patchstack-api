<?php

use Database\Enums\Tables;
use Modules\Organizations\Models\Cluster;
use Modules\Organizations\Models\Thread;
use Modules\Users\Models\User;

beforeEach(function () {
    $this->assertDatabaseCount(Tables::CLUSTERS, 0);
    $this->assertDatabaseCount(Tables::THREADS, 0);

    $this->user = User::factory()->create();
    $this->cluster = Cluster::factory()->create();
});

it('checks if Cluster can attach a user (clustersAdministered relation) single', function () {
    $this->cluster->administrators()->attach($this->user);
    $this->assertSame(1, $this->cluster->administrators->count());
    $this->assertDatabaseHas(Tables::CLUSTER_ADMINISTRATOR, [
        'user_id' => $this->user->id,
        'cluster_id' => $this->cluster->id,
    ]);
});

it('checks if Cluster can attach a user (clustersAdministered relation) multiple', function () {
    $user = User::factory()->create();
    $users = [
        $this->user->id,
        $user->id,
    ];

    $this->cluster->administrators()->sync($users);
    $this->assertSame(count($users), $this->cluster->administrators->count());

    $this->assertDatabaseHas(Tables::CLUSTER_ADMINISTRATOR, [
        'user_id' => $this->user->id,
        'cluster_id' => $this->cluster->id,
    ]);

    $this->assertDatabaseHas(Tables::CLUSTER_ADMINISTRATOR, [
        'user_id' => $user->id,
        'cluster_id' => $this->cluster->id,
    ]);
});

it('returns thread object', function () {
    $this->assertDatabaseCount(Tables::THREADS, 1);

    $cluster = Cluster::factory()->create();

    $this->assertDatabaseCount(Tables::THREADS, 2);

    $thread = $cluster->thread;

    $this->assertInstanceOf(Thread::class, $cluster->thread);
    $this->assertDatabaseHas(Tables::THREADS, [
        'type' => $thread->type,
        'permalink' => $thread->permalink,
        'is_commentable' => $thread->is_commentable,
        'num_comments' => $thread->num_comments,
    ]);
});

it('assert database activity log', function () {
    $this->assertModelActivityLog(Cluster::class);
});
