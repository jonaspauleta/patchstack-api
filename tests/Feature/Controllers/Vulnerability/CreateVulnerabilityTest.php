<?php

use App\Models\User;
use Illuminate\Http\UploadedFile;
use Laravel\Sanctum\Sanctum;

it('creates a new vulnerability', function () {
    $this->user = User::factory()->create([
        'is_admin' => true,
    ]);

    Sanctum::actingAs($this->user);

    $payload = [
        'code' => 'VUL-001',
        'title' => 'Security Vulnerability',
        'overview' => 'A brief overview',
        'description' => 'Full description',
    ];

    $imageFile = UploadedFile::fake()->image('image.jpg');

    $response = $this->postJson(route('vulnerabilities.store'), $payload + ['image' => $imageFile]);

    $response->assertStatus(201);
    $response->assertJsonStructure([
        'id',
        'code',
        'title',
        'overview',
        'description',
        'image_url',
        'user_id',
    ]);

    Storage::delete($imageFile->path());
});

it('returns a forbidden response if user is not authorized', function () {
    $this->user = User::factory()->create([
        'is_admin' => false,
    ]);

    Sanctum::actingAs($this->user);

    $payload = [
        'code' => 'VUL-001',
        'title' => 'Security Vulnerability',
        'overview' => 'A brief overview',
        'description' => 'Full description',
    ];

    $response = $this->postJson('/api/vulnerabilities', $payload);
    $response->assertStatus(403);

    $response->assertJsonStructure([
        'message',
    ]);
});
